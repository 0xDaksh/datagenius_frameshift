<!--

=========================================================
* Argon Design System - v1.1.0
=========================================================

* Product Page: https://www.creative-tim.com/product/argon-design-system
* Copyright 2019 Creative Tim (https://www.creative-tim.com)
* Licensed under MIT (https://github.com/creativetimofficial/argon-dashboard/blob/master/LICENSE.md)

* Coded by Creative Tim

=========================================================

* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software. -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Start your development with a Design System for Bootstrap 4.">
  <meta name="author" content="Creative Tim">
  <title>Argon Design System - Free Design System for Bootstrap 4</title>
  <!-- Favicon -->
  <link href="../assets/img/brand/favicon.png" rel="icon" type="image/png">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
  <!-- Icons -->
  <link href="../assets/vendor/nucleo/css/nucleo.css" rel="stylesheet">
  <link href="../assets/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <!-- Argon CSS -->
  <link type="text/css" href="../assets/css/argon.css?v=1.1.0" rel="stylesheet">
</head>
<style>
th{vertical-align: middle!important;}.active-selection{}
#file-to-upload {
  display: none;
}
#pdf-contents {
  display: none;
}td{font-size:13px;}
</style>
<body>
  <header class="header-global">
    <nav id="navbar-main" class="navbar navbar-main navbar-expand-lg navbar-transparent navbar-light headroom">
      <div class="container">
        <a class="navbar-brand mr-lg-5" href="../index.html">
          <img style="width: 100%;height:auto;" src="../assets/img/brand/logo.png" alt="brand">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar_global" aria-controls="navbar_global" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse" id="navbar_global">
          <div class="navbar-collapse-header">
            <div class="row">
              <div class="col-6 collapse-brand">
                <a href="../index.html">
                  <img src="../assets/img/brand/blue.png" alt="brand">
                </a>
              </div>
              <div class="col-6 collapse-close">
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar_global" aria-controls="navbar_global" aria-expanded="false" aria-label="Toggle navigation">
                  <span></span>
                  <span></span>
                </button>
              </div>
            </div>
          </div>
          <ul class="navbar-nav navbar-nav-hover align-items-lg-center">
            <li class="nav-item dropdown">
              <a href="pdftemplate.html" class="nav-link" >
                <i class="ni ni-ui-04 d-lg-none"></i>
                <span class="nav-link-inner--text">Template</span>
              </a>
            </li>
            <li class="nav-item dropdown">
              <a href="questionans.html" class="nav-link" >
                <i class="ni ni-ui-04 d-lg-none"></i>
                <span class="nav-link-inner--text">Insights</span>
              </a>
            </li>
            <li class="nav-item dropdown">
              <a href="dataextractor.html" class="nav-link" >
                <i class="ni ni-collection d-lg-none"></i>
                <span class="nav-link-inner--text">Extractor</span>
              </a>
            </li>
          </ul>
          <ul class="navbar-nav align-items-lg-center ml-lg-auto">
            <li class="nav-item">
              <a class="nav-link nav-link-icon" href="https://www.facebook.com/creativetim" target="_blank" data-toggle="tooltip" title="Like us on Facebook">
                <i class="fa fa-facebook-square"></i>
                <span class="nav-link-inner--text d-lg-none">Facebook</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link nav-link-icon" href="https://www.linkedin.com/in/dakshmiglani/" target="_blank" data-toggle="tooltip" title="Follow us on Instagram">
                <i class="fa fa-instagram"></i>
                <span class="nav-link-inner--text d-lg-none">Linkedin</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link nav-link-icon" href="https://twitter.com/creativetim" target="_blank" data-toggle="tooltip" title="Follow us on Twitter">
                <i class="fa fa-twitter-square"></i>
                <span class="nav-link-inner--text d-lg-none">Twitter</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link nav-link-icon" href="https://github.com/DakshMiglani/datagenius_frameshift" target="_blank" data-toggle="tooltip" title="Star us on Github">
                <i class="fa fa-github"></i>
                <span class="nav-link-inner--text d-lg-none">Github</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>
  <main>
    <div class="position-relative">
      <!-- shape Hero -->
      <section class="section section-lg section-shaped">
        <div class="shape shape-style-1 shape-default">
        </div>
        <div class="container py-lg-md d-flex">
          <div class="col px-0">
            <div class="row">
              <div class="col-lg-6">
                <h1 class="display-3 text-white">Data Genius Project</h1>
                <p style="color: #fff;fotn-weight:bold;">By</p>
                <img src="assets/img/frameshiftlogo.png" />
                <p class="lead  text-white">Extract Unstructured Data and convert it to Structured Data. Get insights about reports by simply asking your queries.</p>
  
              </div>
            </div>
          </div>
        </div>
        <!-- SVG separator -->
      </section>
      <!-- 1st Hero Variation -->
    </div>
    <section class="section">
        <div class="row-grid align-items-center">
<!--Code goes here-->
<body>
<div class="container-fluid">
<div style="justify-content: center;display: flex;margin:10px 0;" class="form-group row" id="successalert"></div>
<div style="justify-content: center;display: flex;margin:10px 0;" class="form-group row">
<div class="col-md-5">
<div class="form-group row" style="justify-content: center;display: flex"><h3 class="text-primary display-3">PDF Template Design</h3></div>
<div class="form-group row" style="justify-content: center;display: flex">
<div class="col-md-6">
  <input maxlength="20" class="form-control" type="text" placeholder="Template Name" id="templatename" required>
</div>
</div>
<div style="" id="multiplepagesdivv">
<div class="form-group row" style="justify-content: center;display: flex">
</div>  
</div>
<div id="pagenosltdiv">
<input value="1" id="pdfpageno" type="hidden" required> 
</div>

<div style="margin-top:10px;" class="form-group row">
<button style="display:block;margin:0 auto;" class="btn btn-primary agentio-btn-center" id="upload-button">Select PDF</button> 
</div>
<input type="hidden" id="formtype_inp" value="<?php echo $formtype; ?>">
<input type="file" id="file-to-upload" accept="application/pdf" />
<div style="justify-content: center;display: flex;float: left;width: 100%;margin-top: 20px;" class="form-group">
<button type="button" type="button" class="btn btn-primary agentio-btn-center" id="btnsave">Save</button>
</div>
</div>
<div class="col-md-7">
<div style="height:300px;overflow-y:scroll">
<!--Top Table Data-->
<table class="table table-bordered">
  <thead>
    <tr>
      <th class="sticky-th" rowspan="2">Slt</th>
      <th class="sticky-th" rowspan="2">Field Name</th>
      <th class="sticky-th">Width</th>
      <th class="sticky-th">Height</th>
      <th class="sticky-th"></th>
    </tr>
  </thead>
  <tbody id="main_data_table">
    <tr id="1" class="template" data-color="#888888" data-field="1">
      <td><div class="form-check"><input type="checkbox" onclick="areaselect_btn($(this))" class="chkbox form-check-input"></div></td>
      <td data-field="" >
        <input type="text" id="field" placeholder="Fieldname" class="form-control">
      </td>
      <td style="display:none;" id="startx"></td>
      <td style="display:none;" id="starty"></td>
      <td style="display:none;" id="endx"></td>
      <td style="display:none;" id="endy"></td>
      <td id="width_box"></td>
      <td id="height_box"></td>
      <td id="delbtn_obj"><button type="button" id="addrowbtn" class="btn btn-success" onclick="clone_col_row($(this))">Add</button><button type="button" id="removebtn" class="btn btn-danger" onclick="remove_object(newcanv, $(this))">Remove</button></td>
    </tr>
  </tbody>
  
</table>
<!--Main Items Data-->
</div>
</div>
</div>

<div style="float:left;position:relative;width:100%;">
<canvas id="mycanvas" style="border:1px solid #ccc;float:left;" height="1263" width="892"></canvas>
<canvas id="selection_canvas" style="position:absolute;top:0px;left:0px;border:1px solid #ccc;float:left;" height="1263" width="892"></canvas>
<canvas id="newselection_canvas" style="position:absolute;top:0px;left:0px;border:1px solid #ccc;float:left;" height="1263" width="892"></canvas>
</div>
</div>
</body>
<!--DONE CODE-->          
          
        </div>
    </section>    
  </main>
  <!-- Core -->
  <script src="assets/vendor/jquery/jquery.min.js"></script>
  <script src="assets/vendor/popper/popper.min.js"></script>
  <script src="assets/vendor/bootstrap/bootstrap.min.js"></script>
  <script src="assets/vendor/headroom/headroom.min.js"></script>
  <!-- Argon JS -->
  <script src=assets/js/argon.js?v=1.1.0"></script>
  <script src="assets/vendor/pdfjs/pdf.js"></script>
  <script src="assets/vendor/pdfjs/pdf.worker.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.2.0/fabric.min.js"></script>
  <script src='assets/vendor/pdfjs/pdfjs_canvas.js'></script>
<script type="text/javascript">
$('#sample-type').on('change', function(){
  window.location=`${location.protocol}//${location.host}${location.pathname}?type=`+$('#sample-type').val();
}); 
</script>
<script>
function clone_col_row(aa){
  aa.closest('table').find('input[type="checkbox"]').removeClass('active-selection');
  aa.closest('table').find('input[type="checkbox"]').prop('checked',false);
  $new_row = aa.closest('table').find('.template').clone().removeClass('template');
  //Updating new row id
  $prev_row_id = parseInt(aa.closest('table').find('tr').length);
  $new_row_id = $prev_row_id + 1;
  $new_row.prop('id', $new_row_id);
  $new_row.data('field', $new_row_id);
  $new_row.attr('data-field', $new_row_id);
  //Updating input values to none and unchecked
  $new_row.find('input').prop('value', '');
  aa.closest('tbody').append($new_row);
  aa.closest('table').find('input[type="checkbox"]').prop('checked', false);
}
fabric.Object.NUM_FRACTION_DIGITS = 10;
//Adding custom attribute id
fabric.Object.prototype.toObject = (function (toObject) {
    return function (propertiesToInclude) {
        propertiesToInclude = (propertiesToInclude || []).concat(
            ['id', 'width', 'height']
        );
        return toObject.apply(this, [propertiesToInclude]);
    };
})(fabric.Object.prototype.toObject);

function remove_object(canvas, aa){
  let objid = parseInt(aa.closest('tr').data('field'));
  if(objid!=1){
    let currentobj=return_ObjectFromID(newcanv, objid);
    canvas.remove(currentobj);
    aa.closest('tr').remove();
  }else{
    alert("Error: First row not removable. Please change its preferences");
  }
}
function isEmptyObj(obj){
  return Object.entries(obj).length === 0 && obj.constructor === Object;
}
function return_ObjectFromID(canvas, id){
  objreturn={}
  canvas.forEachObject(function(obj) {
        if (obj.id && obj.id === id){
          objreturn=obj;
        }
    });
    return objreturn;
}
function setObjectFromID(canvas, id){
  canvas.forEachObject(function(obj) {
        if (obj.id && obj.id === id){
          canvas.setActiveObject(obj);
        }
    });
    canvas.renderAll();
}
function addRect(canvas, top, left, objid, colorval){
  canvas.add(new fabric.Rect({
    id:objid,top:10,left:10,width:50, height:50, fill:colorval, opacity:0.5,hasRotatingPoint: false
  }));
}
var newcanv=new fabric.Canvas('newselection_canvas');
newcanv.on('object:modified', function(e){
  var actObj = e.target;
    var coords = actObj.calcCoords(); 
    x1 = Math.round(coords.tl.x);
    x2 = Math.round(coords.tr.x);
    y1 = Math.round(coords.tl.y);
    y2 = Math.round(coords.bl.y);
    upd_coordfunc(x1,y1,x2,y2);
});
var max_rows_js=null;
var edit_pdftemplate = {};
var templatepdfurl;
//Edit form load details
function template_details(){
  let templatename=$('#templatename').val();
  load_template_data(templatename, $('#pdfpageno').val());
}
function load_template_data(templatename, pageno){
  $.ajax({
    type : 'post',
    data : {edit_template_name : templatename , pageno : pageno}
  }).done(function(data){
    let jsond=JSON.parse(data);
    canvas_width=parseFloat(jsond.page_width);
    canvas_height=parseFloat(jsond.page_height);
    if(jsond.type=="BILL"){
      boolitmszgroup=(jsond.size_grouping==1) ? true : false;
      $('#itmszgrouping').prop('checked', boolitmszgroup);
    }
    max_rows_js=jsond.max_rows;
    if(jsond.canvas_jsondtlobj!=""){
    newcanv.loadFromJSON(jsond.canvas_jsondtlobj);
    detldetaobj = JSON.parse(jsond.canvas_jsondtlobj);
    for(key in detldetaobj.objects){
      let row=detldetaobj.objects[key];
      $("*[data-field='"+row['id']+"']").find('.chkbox').prop('checked', true);
      $("*[data-field='"+row['id']+"']").find('.chkbox').addClass('active-selection');
      upd_coordfunc(row['left'], row['top'], Math.ceil(parseFloat(row['left'])+(parseFloat(row['width'])*parseFloat(row['scaleX']))), Math.ceil(parseFloat(row['top'])+(parseFloat(row['height'])*parseFloat(row['scaleY']))));
      $("*[data-field='"+row['id']+"']").find('.chkbox').prop('checked', false);
      $("*[data-field='"+row['id']+"']").find('.chkbox').removeClass('active-selection');
    }
    //upd_coordfunc(startx, starty, endx, endy);  
    }
    
  }).fail(function(){
    alert("Posting Failed");
  });
}
//Return all the data
function return_data(){
let data_obj={}
let data_arr=[];
//Top Data 
$('#main_data_table > tr').each(function(){
  if($(this).closest('tr').find('#field').length){
  let field=$(this).closest('tr').find('#field').val();
  let startx=$(this).closest('tr').find('#startx').data('startx');
  let starty=$(this).closest('tr').find('#starty').data('starty');
  let endx=$(this).closest('tr').find('#endx').data('endx');
  let endy=$(this).closest('tr').find('#endy').data('endy');
  let row_obj={field, x1 : startx, y1 : starty, x2 : endx, y2 : endy};
  data_arr.push(row_obj);
  }
});

let jsondata_dtl = JSON.stringify(newcanv);
let pdfpage_no=$('#pdfpageno').val();
data_obj={  name : $('#templatename').val(), pageWidth : canvas_width, pageHeight : canvas_height, jsonColumns: JSON.stringify(data_arr), jsonFabric: JSON.stringify(jsondata_dtl) };
return data_obj;
}

$('#btnsave').on('click', function(){
  if($('#templatename').val().length>0){
  $.ajax({
      type: 'POST',  
      url: `${window.apiurl}/template`,  
      data: JSON.stringify(return_data()),
      dataType : 'json',
      contentType: 'application/json',
    }).done(function(data){ 
    console.log(data);
    $('#successalert').html(`<div class="alert alert-success alert-dismissible fade show" role="alert" style="width:100%;
"><span class="alert-inner--icon"><i class="ni ni-like-2"></i></span>
        <span class="alert-inner--text"><strong>Success!</strong> The template is successfully created. Now scrape 1000s of files all in a single go</span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>`);
    }).fail(function() { 
    alert( "Posting failed." );
    });   
  }else{
    alert("Please enter a valid template name");
  }
});

function areaselect_btn(aa){
  if(aa.is(':checked')){
    aa.addClass('active-selection');
    let objid = aa.closest('tr').data('field');
    let colorval = aa.closest('tr').data('color');
    currentobj=return_ObjectFromID(newcanv, objid);
    if(isEmptyObj(currentobj)){
      addRect(newcanv, 0, 0, objid, colorval);
    }
    setObjectFromID(newcanv, objid);
  }else{
    aa.removeClass('active-selection');
  }
}

//Selection Canvas
var selection_canvaselement=$('#selection_canvas');

function upd_coordfunc(startx, starty, endx, endy){

  //Getting both y-coordinates of default row and updating it only if this selection is of details region
  if(($('.active-selection').closest('tbody').prop('id')=="items_data_table") && ($('.active-selection').closest('tr').prop('class')!='defaulty')){
  let default_y1=$('.defaulty').find('#starty').data('starty');
  let default_y2=$('.defaulty').find('#endy').data('endy');
  if(default_y1!=undefined){
    starty=default_y1;
  }if(default_y2!=undefined){
    endy=default_y2;
  }}
  $('.active-selection').closest('tr').find('#width_box').html(parseInt(endx)-parseInt(startx));
  $('.active-selection').closest('tr').find('#height_box').html(parseInt(endy)-parseInt(starty));
  //Updating data-elements
  $('.active-selection').closest('tr').find('#startx').attr("data-startx", startx);
  $('.active-selection').closest('tr').find('#starty').attr("data-starty", starty);
  $('.active-selection').closest('tr').find('#endx').attr("data-endx", endx);
  $('.active-selection').closest('tr').find('#endy').attr("data-endy", endy);
  //Updating data-elements
  $('.active-selection').closest('tr').find('#startx').data("startx", startx);
  $('.active-selection').closest('tr').find('#starty').data("starty", starty);
  $('.active-selection').closest('tr').find('#endx').data("endx", endx);
  $('.active-selection').closest('tr').find('#endy').data("endy", endy);
}
</script>
</body>

</html>
